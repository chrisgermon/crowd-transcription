{% extends "base.html" %}
{% block title %}Compare {{ txn.accession_number or 'Report' }} — CrowdScription{% endblock %}

{% block content %}
<style>
    .diff-equal { }
    .diff-delete { background-color: #fee2e2; color: #991b1b; text-decoration: line-through; border-radius: 2px; padding: 1px 2px; }
    .diff-insert { background-color: #dcfce7; color: #166534; border-radius: 2px; padding: 1px 2px; }
    .diff-replace-ours { background-color: #fef3c7; color: #92400e; text-decoration: line-through; border-radius: 2px; padding: 1px 2px; }
    .diff-replace-visage { background-color: #dbeafe; color: #1e40af; border-radius: 2px; padding: 1px 2px; }
    .diff-view { line-height: 1.8; }
    .legend-swatch { display: inline-block; width: 14px; height: 14px; border-radius: 2px; vertical-align: middle; margin-right: 4px; }
</style>

<div class="mb-4 flex items-center space-x-4">
    <a href="/compare/" class="text-sm text-indigo-600 hover:text-indigo-800">&larr; Back to comparison list</a>
    <a href="/transcriptions/{{ txn.id }}" class="text-sm text-indigo-600 hover:text-indigo-800">View transcription detail &rarr;</a>
</div>

<!-- Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ txn.accession_number or 'No Accession' }}</h1>
        <p class="text-sm text-gray-500 mt-1">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">{{ site_name }}</span>
            {{ txn.procedure_description or '' }}
            {% if txn.modality_code %}<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">{{ txn.modality_code }}</span>{% endif %}
            &middot; Dr {{ txn.doctor_family_name or '?' }}
            &middot; {{ txn.dictation_date.strftime('%Y-%m-%d') if txn.dictation_date else '—' }}
        </p>
    </div>
    <div class="text-center">
        {% set pct = (similarity * 100)|round(1) %}
        <div class="w-20 h-20 rounded-full flex items-center justify-center text-xl font-bold
            {% if pct >= 80 %}bg-green-100 text-green-700 ring-4 ring-green-300
            {% elif pct >= 60 %}bg-yellow-100 text-yellow-700 ring-4 ring-yellow-300
            {% else %}bg-red-100 text-red-700 ring-4 ring-red-300{% endif %}">
            {{ "%.1f"|format(pct) }}%
        </div>
        <div class="text-xs text-gray-500 mt-1">similarity</div>
    </div>
</div>

<!-- Audio Player -->
{% if txn.audio_relative_path and txn.audio_basename %}
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-5 py-3 flex items-center space-x-4">
        <div class="flex items-center space-x-2 flex-shrink-0">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
            </svg>
            <span class="text-sm font-medium text-gray-700">Dictation Audio</span>
        </div>
        <audio id="audio-player" controls preload="none" class="flex-1 h-10" style="min-width: 0;">
            <source src="/api/audio/{{ txn.id }}" type="{{ txn.audio_mime_type or 'audio/ogg' }}">
            Your browser does not support the audio element.
        </audio>
        <div class="flex items-center space-x-2 flex-shrink-0">
            <select id="playback-rate" onchange="document.getElementById('audio-player').playbackRate = parseFloat(this.value)"
                    class="text-xs border-gray-300 rounded px-2 py-1 border focus:ring-indigo-500 focus:border-indigo-500">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
            </select>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats bar -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="grid grid-cols-4 gap-4 text-center">
        <div>
            <div class="text-lg font-bold text-gray-700">{{ diff_stats.equal }}</div>
            <div class="text-xs text-gray-500">words match</div>
        </div>
        <div>
            <div class="text-lg font-bold text-yellow-600">{{ diff_stats.replace }}</div>
            <div class="text-xs text-gray-500">words differ</div>
        </div>
        <div>
            <div class="text-lg font-bold text-red-600">{{ diff_stats.delete }}</div>
            <div class="text-xs text-gray-500">extra in ours</div>
        </div>
        <div>
            <div class="text-lg font-bold text-green-600">{{ diff_stats.insert }}</div>
            <div class="text-xs text-gray-500">missing (in Visage)</div>
        </div>
    </div>
</div>

<!-- View toggle -->
<div class="flex items-center space-x-2 mb-4">
    <div class="flex rounded-md shadow-sm" role="group">
        <button onclick="showView('unified')" id="btn-unified"
                class="px-4 py-2 text-sm font-medium rounded-l-md border bg-indigo-600 text-white border-indigo-600">
            Unified Diff
        </button>
        <button onclick="showView('sidebyside')" id="btn-sidebyside"
                class="px-4 py-2 text-sm font-medium border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
            Side by Side
        </button>
        <button onclick="showView('raw')" id="btn-raw"
                class="px-4 py-2 text-sm font-medium rounded-r-md border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
            Raw Text
        </button>
    </div>
    <div class="flex-1"></div>
    <div class="text-xs text-gray-500 flex items-center space-x-4">
        <span><span class="legend-swatch" style="background: #fee2e2;"></span>Extra in ours (remove)</span>
        <span><span class="legend-swatch" style="background: #dcfce7;"></span>Missing from ours (add)</span>
        <span><span class="legend-swatch" style="background: #fef3c7;"></span>Our version (wrong)</span>
        <span><span class="legend-swatch" style="background: #dbeafe;"></span>Visage version (correct)</span>
    </div>
</div>

<!-- Unified diff view -->
<div id="view-unified" class="bg-white rounded-lg shadow">
    <div class="px-5 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Unified Diff</h2>
        <p class="text-xs text-gray-500">Shows how our transcription should be changed to match the Visage report</p>
    </div>
    <div class="p-5 diff-view whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">
        {%- for seg in diff_segments -%}
            {%- if seg.type == 'equal' -%}
                {{ seg.our }}{{ " " }}
            {%- elif seg.type == 'delete' -%}
                <span class="diff-delete" title="Extra in our transcript">{{ seg.our }}</span>{{ " " }}
            {%- elif seg.type == 'insert' -%}
                <span class="diff-insert" title="Missing from our transcript (in Visage report)">{{ seg.visage }}</span>{{ " " }}
            {%- elif seg.type == 'replace' -%}
                <span class="diff-replace-ours" title="Our version">{{ seg.our }}</span>
                <span class="diff-replace-visage" title="Visage version">{{ seg.visage }}</span>{{ " " }}
            {%- endif -%}
        {%- endfor -%}
    </div>
</div>

<!-- Side-by-side view -->
<div id="view-sidebyside" class="bg-white rounded-lg shadow hidden">
    <div class="px-5 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Side by Side</h2>
    </div>
    <div class="grid grid-cols-2 divide-x divide-gray-200">
        <div class="p-5">
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">CrowdScription (Deepgram)</div>
            <div class="diff-view whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">
                {%- for seg in diff_segments -%}
                    {%- if seg.type == 'equal' -%}
                        {{ seg.our }}{{ " " }}
                    {%- elif seg.type == 'delete' -%}
                        <span class="diff-delete">{{ seg.our }}</span>{{ " " }}
                    {%- elif seg.type == 'insert' -%}
                        {#- nothing on our side -#}
                    {%- elif seg.type == 'replace' -%}
                        <span class="diff-replace-ours">{{ seg.our }}</span>{{ " " }}
                    {%- endif -%}
                {%- endfor -%}
            </div>
        </div>
        <div class="p-5">
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Visage Report (Transcriptionist)</div>
            <div class="diff-view whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">
                {%- for seg in diff_segments -%}
                    {%- if seg.type == 'equal' -%}
                        {{ seg.visage }}{{ " " }}
                    {%- elif seg.type == 'delete' -%}
                        {#- nothing on visage side -#}
                    {%- elif seg.type == 'insert' -%}
                        <span class="diff-insert">{{ seg.visage }}</span>{{ " " }}
                    {%- elif seg.type == 'replace' -%}
                        <span class="diff-replace-visage">{{ seg.visage }}</span>{{ " " }}
                    {%- endif -%}
                {%- endfor -%}
            </div>
        </div>
    </div>
</div>

<!-- Raw text view -->
<div id="view-raw" class="hidden">
    <p class="text-xs text-gray-500 mb-3">Showing normalised text (section headings and procedure titles stripped for comparison). Toggle to see full original text.</p>
    <div class="flex items-center space-x-2 mb-3">
        <button onclick="toggleRawView('normalised')" id="btn-normalised" class="px-3 py-1 text-xs font-medium rounded border bg-gray-600 text-white border-gray-600">Normalised</button>
        <button onclick="toggleRawView('full')" id="btn-full" class="px-3 py-1 text-xs font-medium rounded border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">Full Original</button>
    </div>
    <div id="raw-normalised" class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-lg shadow">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">CrowdScription (Normalised)</h2>
            </div>
            <div class="p-5 whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">{{ our_normalised or '(empty)' }}</div>
        </div>
        <div class="bg-white rounded-lg shadow">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Visage Report (Normalised)</h2>
            </div>
            <div class="p-5 whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">{{ visage_normalised or '(empty)' }}</div>
        </div>
    </div>
    <div id="raw-full" class="grid grid-cols-2 gap-4 hidden">
        <div class="bg-white rounded-lg shadow">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">CrowdScription (Full)</h2>
            </div>
            <div class="p-5 whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">{{ txn.formatted_text or '(empty)' }}</div>
        </div>
        <div class="bg-white rounded-lg shadow">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Visage Report (Full)</h2>
            </div>
            <div class="p-5 whitespace-pre-wrap text-sm text-gray-800 leading-relaxed">{{ visage_text or '(empty)' }}</div>
        </div>
    </div>
</div>

<script>
function showView(view) {
    var views = ['unified', 'sidebyside', 'raw'];
    var buttons = {
        'unified': document.getElementById('btn-unified'),
        'sidebyside': document.getElementById('btn-sidebyside'),
        'raw': document.getElementById('btn-raw')
    };
    views.forEach(function(v) {
        var el = document.getElementById('view-' + v);
        var btn = buttons[v];
        if (v === view) {
            el.classList.remove('hidden');
            btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        } else {
            el.classList.add('hidden');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
        }
    });
}

function toggleRawView(mode) {
    var norm = document.getElementById('raw-normalised');
    var full = document.getElementById('raw-full');
    var btnNorm = document.getElementById('btn-normalised');
    var btnFull = document.getElementById('btn-full');
    if (mode === 'full') {
        norm.classList.add('hidden');
        full.classList.remove('hidden');
        btnFull.classList.add('bg-gray-600', 'text-white', 'border-gray-600');
        btnFull.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        btnNorm.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        btnNorm.classList.remove('bg-gray-600', 'text-white', 'border-gray-600');
    } else {
        full.classList.add('hidden');
        norm.classList.remove('hidden');
        btnNorm.classList.add('bg-gray-600', 'text-white', 'border-gray-600');
        btnNorm.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        btnFull.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        btnFull.classList.remove('bg-gray-600', 'text-white', 'border-gray-600');
    }
}
</script>
{% endblock %}
