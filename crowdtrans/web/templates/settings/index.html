{% extends "base.html" %}
{% block title %}Settings — CrowdScription{% endblock %}

{% block content %}
<div class="space-y-8">
    <h1 class="text-2xl font-bold text-gray-900">Settings</h1>

    {# ── Global Settings ── #}
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Global Settings</h2>
            <p class="text-sm text-gray-500 mt-1">Deepgram API configuration and default processing parameters.</p>
        </div>
        <form method="post" action="/settings/global" class="px-6 py-5 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                {# RIS Type #}
                <div class="md:col-span-2">
                    <label for="ris_type" class="block text-sm font-medium text-gray-700">RIS System</label>
                    <select name="ris_type" id="ris_type"
                            class="mt-1 block w-full md:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        <option value="visage" {{ 'selected' if globals.ris_type == 'visage' or not globals.ris_type }}>Visage</option>
                        <option value="karisma" {{ 'selected' if globals.ris_type == 'karisma' }}>Karisma</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">All sites and reports will reference the selected RIS system.</p>
                </div>

                {# Deepgram API Key #}
                <div class="md:col-span-2">
                    <label for="deepgram_api_key" class="block text-sm font-medium text-gray-700">Deepgram API Key</label>
                    <div class="mt-1 relative">
                        <input type="password" name="deepgram_api_key" id="deepgram_api_key"
                               value="{{ globals.deepgram_api_key }}"
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10 border px-3 py-2">
                        <button type="button" onclick="togglePassword('deepgram_api_key')"
                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                {# Model #}
                <div>
                    <label for="deepgram_model" class="block text-sm font-medium text-gray-700">Model</label>
                    <select name="deepgram_model" id="deepgram_model"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        <option value="nova-3-medical" {{ 'selected' if globals.deepgram_model == 'nova-3-medical' }}>nova-3-medical</option>
                        <option value="nova-3" {{ 'selected' if globals.deepgram_model == 'nova-3' }}>nova-3</option>
                        <option value="nova-2-medical" {{ 'selected' if globals.deepgram_model == 'nova-2-medical' }}>nova-2-medical</option>
                        <option value="nova-2" {{ 'selected' if globals.deepgram_model == 'nova-2' }}>nova-2</option>
                    </select>
                </div>

                {# Language #}
                <div>
                    <label for="deepgram_language" class="block text-sm font-medium text-gray-700">Language</label>
                    <select name="deepgram_language" id="deepgram_language"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        <option value="en-AU" {{ 'selected' if globals.deepgram_language == 'en-AU' }}>English (Australia)</option>
                        <option value="en-US" {{ 'selected' if globals.deepgram_language == 'en-US' }}>English (US)</option>
                        <option value="en-GB" {{ 'selected' if globals.deepgram_language == 'en-GB' }}>English (UK)</option>
                        <option value="en" {{ 'selected' if globals.deepgram_language == 'en' }}>English (General)</option>
                    </select>
                </div>

                {# Poll Interval #}
                <div>
                    <label for="poll_interval_seconds" class="block text-sm font-medium text-gray-700">Default Poll Interval (seconds)</label>
                    <input type="number" name="poll_interval_seconds" id="poll_interval_seconds"
                           value="{{ globals.poll_interval_seconds }}" min="5" max="3600"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                </div>

                {# Batch Size #}
                <div>
                    <label for="batch_size" class="block text-sm font-medium text-gray-700">Default Batch Size</label>
                    <input type="number" name="batch_size" id="batch_size"
                           value="{{ globals.batch_size }}" min="1" max="100"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                </div>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save Global Settings
                </button>
            </div>
        </form>
    </div>

    {# ── Site Configurations ── #}
    <div class="space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Site Configurations</h2>
                <p class="text-sm text-gray-500 mt-1">Manage RIS database connections for each site.</p>
            </div>
            <button type="button" onclick="toggleNewSiteForm()"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add Site
            </button>
        </div>

        {# ── New Site Form (hidden by default) ── #}
        <div id="new-site-form" class="hidden bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-md font-semibold text-gray-900">New Site</h3>
            </div>
            <form method="post" action="/settings/sites/new" class="px-6 py-5 space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Site ID</label>
                        <input type="text" name="site_id" required placeholder="e.g. visage-2"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Site Name</label>
                        <input type="text" name="site_name" required placeholder="e.g. My Radiology Clinic"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">RIS Type</label>
                        <select name="ris_type" onchange="updateAudioFields(this, 'new')"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                            <option value="visage">Visage</option>
                            <option value="karisma">Karisma</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DB Host</label>
                        <input type="text" name="db_host" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DB Port</label>
                        <input type="number" name="db_port" required value="5432"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DB Name</label>
                        <input type="text" name="db_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DB User</label>
                        <input type="text" name="db_user" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DB Password</label>
                        <div class="mt-1 relative">
                            <input type="password" name="db_password" id="new_db_password" required
                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10 border px-3 py-2">
                            <button type="button" onclick="togglePassword('new_db_password')"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="new-audio-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Audio Source</label>
                        <input type="text" name="audio_source" value="nfs" readonly
                               class="mt-1 block w-full rounded-md border-gray-200 bg-gray-50 shadow-sm sm:text-sm border px-3 py-2">
                    </div>
                    <div id="new-mount-path">
                        <label class="block text-sm font-medium text-gray-700">Audio Mount Path</label>
                        <input type="text" name="audio_mount_path" placeholder="/mnt/audio"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Poll Interval (seconds)</label>
                        <input type="number" name="poll_interval_seconds" value="30" min="5" max="3600"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Batch Size</label>
                        <input type="number" name="batch_size" value="10" min="1" max="100"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="toggleNewSiteForm()"
                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Add Site
                    </button>
                </div>
            </form>
        </div>

        {# ── Existing Sites ── #}
        {% for site in sites %}
        <div class="bg-white shadow rounded-lg" id="site-card-{{ site.site_id }}">
            <div class="px-6 py-4 flex items-center justify-between border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <h3 class="text-md font-semibold text-gray-900">{{ site.site_name }}</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">{{ site.site_id }}</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                        {% if site.ris_type == 'visage' %}bg-blue-100 text-blue-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                        {{ site.ris_type | capitalize }}
                    </span>
                    <span id="toggle-badge-{{ site.site_id }}"
                          hx-post="/settings/sites/{{ site.site_id }}/toggle"
                          hx-target="#toggle-badge-{{ site.site_id }}"
                          hx-swap="outerHTML"
                          class="cursor-pointer inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if site.enabled %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ "Enabled" if site.enabled else "Disabled" }}
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button"
                            hx-post="/settings/sites/{{ site.site_id }}/test"
                            hx-target="#test-result-{{ site.site_id }}"
                            hx-swap="innerHTML"
                            hx-indicator="#test-spinner-{{ site.site_id }}"
                            class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <svg id="test-spinner-{{ site.site_id }}" class="htmx-indicator animate-spin -ml-0.5 mr-1.5 h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        Test Connection
                    </button>
                    <button type="button" onclick="toggleSiteEdit('{{ site.site_id }}')"
                            class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Edit
                    </button>
                    <form method="post" action="/settings/sites/{{ site.site_id }}/delete" class="inline"
                          onsubmit="return confirm('Delete site {{ site.site_name }}? Historical transcriptions will be preserved.')">
                        <button type="submit"
                                class="inline-flex items-center px-3 py-1.5 border border-red-300 rounded-md text-xs font-medium text-red-700 bg-white hover:bg-red-50">
                            Delete
                        </button>
                    </form>
                </div>
            </div>

            {# Test result area #}
            <div id="test-result-{{ site.site_id }}" class="px-6 py-2 empty:hidden"></div>

            {# Summary row (visible when not editing) #}
            <div id="site-summary-{{ site.site_id }}" class="px-6 py-3 text-sm text-gray-600">
                <span class="font-medium">{{ site.db_host }}:{{ site.db_port }}/{{ site.db_name }}</span>
                &middot; User: {{ site.db_user }}
                &middot; Poll: {{ site.poll_interval_seconds }}s
                &middot; Batch: {{ site.batch_size }}
                {% if site.audio_mount_path %}&middot; Audio: {{ site.audio_mount_path }}{% endif %}
            </div>

            {# Edit form (hidden by default) #}
            <div id="site-edit-{{ site.site_id }}" class="hidden">
                <form method="post" action="/settings/sites/{{ site.site_id }}" class="px-6 py-5 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Site Name</label>
                            <input type="text" name="site_name" value="{{ site.site_name }}" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">RIS Type</label>
                            <select name="ris_type" onchange="updateAudioFields(this, '{{ site.site_id }}')"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                                <option value="visage" {{ 'selected' if site.ris_type == 'visage' }}>Visage</option>
                                <option value="karisma" {{ 'selected' if site.ris_type == 'karisma' }}>Karisma</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DB Host</label>
                            <input type="text" name="db_host" value="{{ site.db_host }}" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DB Port</label>
                            <input type="number" name="db_port" value="{{ site.db_port }}" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DB Name</label>
                            <input type="text" name="db_name" value="{{ site.db_name }}" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DB User</label>
                            <input type="text" name="db_user" value="{{ site.db_user }}" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">DB Password</label>
                            <div class="mt-1 relative">
                                <input type="password" name="db_password" id="db_password_{{ site.site_id }}"
                                       placeholder="(unchanged if blank)"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pr-10 border px-3 py-2">
                                <button type="button" onclick="togglePassword('db_password_{{ site.site_id }}')"
                                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="{{ site.site_id }}-audio-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Audio Source</label>
                            <input type="text" name="audio_source" value="{{ site.audio_source }}" readonly
                                   class="mt-1 block w-full rounded-md border-gray-200 bg-gray-50 shadow-sm sm:text-sm border px-3 py-2">
                        </div>
                        <div id="{{ site.site_id }}-mount-path" class="{{ 'hidden' if site.ris_type == 'karisma' }}">
                            <label class="block text-sm font-medium text-gray-700">Audio Mount Path</label>
                            <input type="text" name="audio_mount_path" value="{{ site.audio_mount_path or '' }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Poll Interval (seconds)</label>
                            <input type="number" name="poll_interval_seconds" value="{{ site.poll_interval_seconds }}" min="5" max="3600"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Batch Size</label>
                            <input type="number" name="batch_size" value="{{ site.batch_size }}" min="1" max="100"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2">
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" onclick="toggleSiteEdit('{{ site.site_id }}')"
                                class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}

        {% if not sites %}
        <div class="bg-white shadow rounded-lg px-6 py-8 text-center text-gray-500">
            No sites configured. Click "Add Site" to get started.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
